<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AltPay Shop</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <h1 class="app-title">AltPay Shop</h1>
            <div class="user-info">
                <span class="username">Welcome, {{ username }}!</span>
                <a href="{{ url_for('logout') }}" class="btn btn-small logout-btn">Logout</a>
            </div>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="card">
            <h2 class="section-title">Create Product</h2>
            <form id="productForm" class="product-form">
                <label for="productName">Name</label>
                <input type="text" id="productName" placeholder="e.g. Coffee" required>
                <label for="productPrice">Price</label>
                <input type="number" id="productPrice" step="0.01" min="0.01" placeholder="9.90" required>
                <button type="submit" class="btn btn-primary">Add product</button>
            </form>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="section-title">Products</h2>
                <span class="badge">{{ products|length }}</span>
            </div>
            {% if products %}
            <div style="margin-bottom:12px">
                <label class="checkbox-label"><input type="checkbox" id="selectAllProducts" onchange="toggleSelectAll()"> Select all</label>
                <button id="bulkPrintBtn" class="btn-small btn-primary" onclick="preparePrintFromProducts()" style="display:none;margin-left:8px">Print Selected</button>
                <button id="bulkDeleteBtn" class="btn-small btn-danger" onclick="bulkDeleteProducts()" style="display:none;margin-left:8px">Delete Selected</button>
            </div>
            <div id="productsList">
                {% for product in products %}
                <div class="product-row" data-product-id="{{ product.id }}">
                    <div class="product-checkbox"><input type="checkbox" class="product-checkbox-input" value="{{ product.id }}" onchange="updateBulkDeleteButton()"></div>
                    <div class="product-info">
                        <div class="product-name">{{ product.name }}</div>
                        <div class="product-price">${{ "%.2f"|format(product.price) }}</div>
                        <div class="product-actions">
                            <button type="button" class="btn-small" onclick="addToCartFromList('{{ product.id }}')">Add to cart</button>
                            <button type="button" class="btn-small btn-edit" onclick="openEditModal('{{ product.id }}', {{ product.name|tojson }}, {{ product.price }})">Edit</button>
                            {% if product.id not in ['1','2','3'] %}
                            <button type="button" class="btn-small btn-danger" onclick="deleteProduct('{{ product.id }}', {{ product.name|tojson }})">Delete</button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="qr-container"><img src="{{ url_for('get_product_qr', product_id=product.id) }}" alt="QR" class="qr-image"></div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="empty-text">No products yet. Add one above.</p>
            {% endif %}
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="section-title">Cart</h2>
                <span class="badge">{{ cart|length }}</span>
            </div>
            <button type="button" class="btn btn-outline" onclick="openScanner()">Scan QR Code</button>
            <div id="cartList">
                {% if cart %}
                {% for item in cart %}
                <div class="cart-row"><span class="cart-name">{{ item.name }}</span><span class="cart-price">${{ "%.2f"|format(item.price) }}</span></div>
                {% endfor %}
                <div class="cart-total-row"><span class="cart-total-label">Total</span><span class="cart-total-value">${{ "%.2f"|format(cart_total) }}</span></div>
                <button type="button" class="btn btn-primary" onclick="preparePrintFromCart()" style="margin-top:12px">Print Cart</button>
                <button type="button" class="btn btn-danger" onclick="clearCart()" style="margin-top:8px">Clear Cart</button>
                {% else %}
                <p class="empty-text">Cart is empty. Scan a QR or add from list.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Edit Product</h2><button type="button" class="close-btn" onclick="closeEditModal()">&times;</button></div>
            <form id="editProductForm" class="product-form">
                <input type="hidden" id="editProductId">
                <label for="editProductName">Name</label><input type="text" id="editProductName" required>
                <label for="editProductPrice">Price</label><input type="number" id="editProductPrice" step="0.01" min="0.01" required>
                <div style="display:flex;gap:12px;margin-top:16px">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="printModal" class="modal">
        <div class="modal-content print-modal-content">
            <div class="print-header"><h2>Print Preview</h2><div class="print-actions"><button type="button" class="btn btn-primary" onclick="window.print()">Print</button><button type="button" class="btn btn-outline" onclick="closePrintModal()">Close</button></div></div>
            <div id="printContent" class="print-content"></div>
        </div>
    </div>

    <div id="scannerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Scan QR Code</h2><button type="button" class="close-btn" onclick="closeScanner()">&times;</button></div>
            <div class="scanner-container">
                <video id="video" autoplay playsinline webkit-playsinline muted></video>
                <canvas id="canvas" style="display:none"></canvas>
                <div class="scanner-overlay-ui"><div class="scanner-frame"></div><button id="switchCameraBtn" type="button" class="camera-switch-btn" onclick="switchCamera()" title="Switch camera" style="display:none">&#8634;</button></div>
            </div>
            <p id="scannerStatus" class="scanner-status">Point camera at QR code...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
